@model WebApplication1.ViewModels.AttendanceHistoryViewModel
@{
    ViewData["Title"] = "Attendance History";
    ViewData["PageTitle"] = $"Attendance History - {Model.ClassCode}";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

@section SidebarMenu {
    @await Html.PartialAsync("_LecturerSidebar")
}

@section Styles {
    <link rel="stylesheet" href="~/css/portal-common.css" />
}

<!-- Header -->
<div class="portal-filter-bar">
    <div>
        <h6 style="margin: 0; color: var(--portal-primary); font-weight: 600;">
            <i class="bi bi-clock-history me-2" style="color: var(--portal-accent);"></i>@Model.SubjectName
        </h6>
        <small style="color: var(--portal-text-muted);">Class: @Model.ClassCode</small>
    </div>
    <div style="display: flex; gap: 0.5rem;">
        <a asp-action="TakeAttendance" asp-route-id="@Model.CourseClassId" class="portal-btn portal-btn-accent portal-btn-sm">
            <i class="bi bi-clipboard-check"></i> Take Attendance
        </a>
        <a asp-action="Index" class="portal-btn portal-btn-outline portal-btn-sm">
            <i class="bi bi-arrow-left"></i> Back
        </a>
    </div>
</div>

<!-- Stats -->
@if (Model.StudentStats.Any())
{
    <div class="portal-stats">
        <div class="portal-stat-card">
            <div class="portal-stat-icon primary">
                <i class="bi bi-calendar-check"></i>
            </div>
            <div class="portal-stat-info">
                <h4>@Model.Records.Count</h4>
                <p>Total Sessions</p>
            </div>
        </div>
        <div class="portal-stat-card">
            <div class="portal-stat-icon accent">
                <i class="bi bi-people"></i>
            </div>
            <div class="portal-stat-info">
                <h4>@Model.StudentStats.Count</h4>
                <p>Total Students</p>
            </div>
        </div>
        <div class="portal-stat-card">
            <div class="portal-stat-icon primary">
                <i class="bi bi-percent"></i>
            </div>
            <div class="portal-stat-info">
                <h4>@Model.StudentStats.Values.Average(s => s.AttendanceRate).ToString("F1")%</h4>
                <p>Average Rate</p>
            </div>
        </div>
    </div>
}

<!-- Session History -->
<div class="portal-card" style="margin-bottom: 1.5rem;">
    <div class="portal-card-header">
        <h5><i class="bi bi-list-ul"></i> Attendance Sessions</h5>
    </div>
    <div class="portal-card-body p-0">
        @if (Model.Records.Any())
        {
            <table class="portal-table">
                <thead>
                    <tr>
                        <th style="width: 50px;">#</th>
                        <th>Date</th>
                        <th>Session</th>
                        <th style="text-align: center;">Total</th>
                        <th style="text-align: center;">Present</th>
                        <th style="text-align: center;">Absent</th>
                        <th style="text-align: center;">Rate</th>
                        <th style="width: 90px;"></th>
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < Model.Records.Count; i++)
                    {
                        var record = Model.Records[i];
                        var rateClass = record.AttendanceRate >= 80 ? "portal-badge-success" :
                                       record.AttendanceRate >= 60 ? "portal-badge-warning" : "portal-badge-danger";
                        <tr>
                            <td style="text-align: center;">@(i + 1)</td>
                            <td>
                                <i class="bi bi-calendar-date me-1" style="color: var(--portal-accent);"></i>
                                @record.SessionDate.ToString("dd/MM/yyyy")
                            </td>
                            <td>
                                <i class="bi bi-clock me-1" style="color: var(--portal-accent);"></i>
                                @record.Session
                            </td>
                            <td style="text-align: center;">
                                <span class="portal-badge portal-badge-primary">@record.TotalStudents</span>
                            </td>
                            <td style="text-align: center;">
                                <span class="portal-badge portal-badge-success">@record.PresentCount</span>
                            </td>
                            <td style="text-align: center;">
                                <span class="portal-badge portal-badge-danger">@record.AbsentCount</span>
                            </td>
                            <td style="text-align: center;">
                                <span class="portal-badge @rateClass">@record.AttendanceRate.ToString("F1")%</span>
                            </td>
                            <td style="text-align: center;">
                                <a asp-action="TakeAttendance"
                                   asp-route-id="@Model.CourseClassId"
                                   asp-route-date="@record.SessionDate.ToString("yyyy-MM-dd")"
                                   asp-route-session="@record.Session"
                                   class="portal-btn portal-btn-outline portal-btn-sm">
                                    Edit
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <div class="portal-empty">
                <i class="bi bi-calendar-x"></i>
                <p>No attendance records found</p>
            </div>
        }
    </div>
</div>

<!-- Student Statistics -->
<div class="portal-card">
    <div class="portal-card-header">
        <h5><i class="bi bi-people"></i> Student Attendance Statistics</h5>
    </div>
    <div class="portal-card-body p-0">
        @if (Model.StudentStats.Any())
        {
            <table class="portal-table">
                <thead>
                    <tr>
                        <th style="width: 50px;">#</th>
                        <th style="width: 120px;">Student Code</th>
                        <th>Full Name</th>
                        <th style="text-align: center;">Sessions</th>
                        <th style="text-align: center;">Present</th>
                        <th style="text-align: center;">Absent</th>
                        <th style="width: 150px;">Rate</th>
                        <th style="text-align: center; width: 80px;">Score</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        int index = 1;
                        foreach (var stat in Model.StudentStats.Values.OrderBy(s => s.StudentCode))
                        {
                            var scoreClass = stat.AttendanceScore >= 8 ? "portal-grade-a" :
                                           stat.AttendanceScore >= 5 ? "portal-grade-c" : "portal-grade-d";
                            <tr>
                                <td style="text-align: center;">@index</td>
                                <td><span class="portal-badge portal-badge-primary">@stat.StudentCode</span></td>
                                <td><strong>@stat.FullName</strong></td>
                                <td style="text-align: center;">@stat.TotalSessions</td>
                                <td style="text-align: center;">
                                    <span class="portal-badge portal-badge-success">@stat.PresentSessions</span>
                                </td>
                                <td style="text-align: center;">
                                    <span class="portal-badge portal-badge-danger">@stat.AbsentSessions</span>
                                </td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <div class="portal-progress" style="flex: 1;">
                                            <div class="portal-progress-bar" style="width: @stat.AttendanceRate.ToString("F1")%"></div>
                                        </div>
                                        <small style="width: 40px; text-align: right;">@stat.AttendanceRate.ToString("F0")%</small>
                                    </div>
                                </td>
                                <td style="text-align: center;">
                                    <span class="portal-grade-badge @scoreClass">@stat.AttendanceScore.ToString("F1")</span>
                                </td>
                            </tr>
                            index++;
                        }
                    }
                </tbody>
            </table>
        }
        else
        {
            <div class="portal-empty">
                <i class="bi bi-people"></i>
                <p>No student statistics available</p>
            </div>
        }
    </div>
</div>

<!-- Note -->
<div class="portal-alert portal-alert-success" style="margin-top: 1rem;">
    <i class="bi bi-info-circle"></i>
    <span><strong>Note:</strong> Attendance score (max 10) contributes 10% to the final grade.</span>
</div>
